---
title: "Biostat 203B Homework 2"
author: "Ami Sheth"
subtitle: Due Feb 7 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r}
sessionInfo()
```

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-III](https://mimic.physionet.org) data introduced in [homework 1](https://ucla-biostat203b-2020winter.github.io/hw/hw1/hw1.html).

## Q1

Demographic information of the patients admitted into hospital is available in `ADMISSION.csv`. See <https://mimic.physionet.org/mimictables/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs:   

- admission year  
- admission month  
- admission week day  
- admission hour  
- length of hospital stay  
- admission type  
- number of admissions per patient  
- admission location  
- insurance  
- language  
- religion  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on only unique patients. 

**Solution:**

### Prerequistites 

Load tidyverse and lubridate:
```{r}
library(tidyverse)
library(lubridate)
```

### Import data
Let's first display the first 10 lines of the `ADMISSION.csv` file:
```{bash}
head /home/203bdata/mimic-iii/ADMISSIONS.csv
```

First try of parsing the data:
```{r}
admission <- read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv",
                      col_types = cols(ROW_ID = col_integer(),
                                       SUBJECT_ID = col_integer(),
                                       HADM_ID = col_integer(),
                                       HOSPITAL_EXPIRE_FLAG = col_logical(),
                                       HAS_CHARTEVENTS_DATA = col_logical()))
```

## Summarizing the Data 

- Admission year

```{r}
admission %>% mutate(adm_year = year(ADMITTIME)) %>% ggplot() + geom_bar(mapping = aes(x = adm_year)) + xlab("Year of Admission") + ggtitle("Barplot of Admission Year") + theme(plot.title = element_text(hjust = 0.5))
```

- Admission month

```{r}
admission %>% mutate(adm_month = month(ADMITTIME, label = T)) %>% ggplot() + geom_bar(mapping = aes(x = adm_month)) + xlab("Month of Admission") + ggtitle("Barplot of Admission Month") + theme(plot.title = element_text(hjust = 0.5))
```

- Admission week day

```{r}
admission %>% mutate(adm_day = day(ADMITTIME)) %>% ggplot() + geom_bar(mapping = aes(x = adm_day)) + xlab("Day of Admission") + ggtitle("Barplot of Admission Day") + theme(plot.title = element_text(hjust = 0.5))
```

- Admission hour

```{r}
admission %>% mutate(adm_hour = hour(ADMITTIME)) %>% ggplot() + geom_bar(mapping = aes(x = adm_hour)) + xlab("Hour of Admission") + ggtitle("Barplot of Admission Hour") + theme(plot.title = element_text(hjust = 0.5))
```

- Admission minute

```{r}
admission %>% mutate(adm_min = minute(ADMITTIME)) %>% ggplot() + geom_freqpoly(binwidth = 2, mapping = aes(x = adm_min)) + xlab("Minute of Admission") + ggtitle("Plot of Admission Minute") + theme(plot.title = element_text(hjust = 0.5))
```

- Length of hospital stay 

```{r}
admission %>% mutate(stay_length = as.numeric(as.duration(DISCHTIME-ADMITTIME)/ 86400)) %>% ggplot() + geom_density(mapping = aes(x = stay_length)) + xlab("Length of Stay (days)") + ggtitle("Plot of Length of Hospital Stay") + theme(plot.title = element_text(hjust = 0.5))
```

- Admission type  

```{r}
admission %>% ggplot() + geom_bar(mapping = aes(x = ADMISSION_TYPE)) + xlab("Admission Type") + ggtitle("Barplot of Admission Type") + theme(plot.title = element_text(hjust = 0.5))
```

- Number of admissions per patient  

```{r}
admission %>% count(SUBJECT_ID) %>% ggplot() + geom_bar(mapping = aes(x = n)) + xlab("Number of Admissions") + ggtitle("Frequency of Admissions per Patient") + theme(plot.title = element_text(hjust = 0.5))
```

- Admission location  

```{r}
admission %>% ggplot() + geom_bar(mapping = aes(x = ADMISSION_LOCATION)) + coord_flip() + xlab("Admission Location") + ggtitle("Barplot of Admission Location")
```

- Insurance  

```{r}
admission %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% ggplot() + geom_bar(mapping = aes(x = INSURANCE)) + ggtitle("Plot of Patient Insurance") + theme(plot.title = element_text(hjust = 0.5))
```

- Language  

```{r}
top_lang <- admission %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% count(LANGUAGE) %>% na.omit(LANGUAGE) %>% arrange(desc(n)) %>% slice(1:10)

top_lang %>% ggplot(mapping = aes(x = LANGUAGE, y = n, fill = LANGUAGE)) + geom_bar(stat = "identity") + labs(title = "Top Ten Patient Languages", y = "Count", x = "Language") + theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
 
```

- Religion  

```{r}
admission %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% ggplot() + geom_bar(mapping = aes(x = RELIGION)) + ggtitle("Plot of Patient Religion") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
```

- Marital status 

```{r}
admission %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% ggplot() + geom_bar(mapping = aes(x = MARITAL_STATUS)) + ggtitle("Plot of Marital Status") + xlab("Marital Status") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
```

- Ethnicity  

```{r}
top_eth <- admission %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% count(ETHNICITY) %>% arrange(desc(n)) %>% slice(1:10)

top_eth %>% ggplot(mapping = aes(x = ETHNICITY, y = n)) + geom_bar(stat = "identity") + ggtitle("Plot of Patient Ethnicity") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1, size = 6)) + scale_x_discrete(drop = F)

```

- Death year

```{r, warning=FALSE}
admission %>% mutate(death_year = year(DEATHTIME)) %>% ggplot() + geom_freqpoly(mapping = aes(x = death_year), bins = 40) + xlab("Year of Death") + ggtitle("Plot of In-Hospital Death Each Year") + theme(plot.title = element_text(hjust = 0.5))
```


## Q2

Link the data in `ADMISSION.csv` and `PATIENTS.csv` (<https://mimic.physionet.org/mimictables/patients/>) and summarize following variables using appropriate graphs:  

- gender  
- age at admission 

**Solution**

First let's read and parse the `PATIENTS.csv` data.

```{r}
patient <- read_csv("/home/203bdata/mimic-iii/PATIENTS.csv",
                    col_types = cols(ROW_ID = col_integer(),
                                     SUBJECT_ID = col_integer(),
                                     EXPIRE_FLAG = col_character()))
                    
```

Let's merge the `ADMISSION.csv` and `PATIENTS.csv` together by `SUBJECT_ID`

```{r}
adm_unique <- admission %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% select("SUBJECT_ID","ADMITTIME")

patient_adm <- inner_join(patient, adm_unique, by = "SUBJECT_ID")
```

- Gender

```{r}
patient_adm %>% ggplot() + geom_bar(mapping = aes(x = factor(GENDER), y = ..prop.., group = 1), stat = "count") + scale_x_discrete(label = c("Female", "Male")) + labs(title = "Gender of Patients", y = "Proportion", x = "Gender") + theme(plot.title = element_text(hjust = 0.5))
```

- Age at admission 

```{r}
patient_adm %>% mutate(age_adm = as.numeric(as.duration(ADMITTIME - DOB), "years")) %>% ggplot() + geom_histogram(mapping = aes(x = age_adm), bins = 50) + labs(title = "Age of Patients", x = "Age (yrs)") + theme(plot.title = element_text(hjust = 0.5))
```


## Q3

`ICUSTAYS.csv` (<https://mimic.physionet.org/mimictables/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate graphs:  

- length of ICU stay  
- first ICU unit  
- gender  
- age  

**Solution:**

First let's read and parse the `ICUSTAYS.csv` data.

```{r}
icu <- read_csv("/home/203bdata/mimic-iii/ICUSTAYS.csv",
                    col_types = cols(ROW_ID = col_integer(),
                                     SUBJECT_ID = col_integer(),
                                     HADM_ID = col_integer(),
                                     ICUSTAY_ID = col_integer(),
                                     FIRST_WARDID = col_integer(),
                                     LAST_WARDID = col_integer()))
```

- Length of ICU stay

```{r, warning = FALSE}
icu %>% ggplot() + geom_histogram(mapping = aes(x = LOS), bins = 100) + labs(title = "Plot of Length of ICU Stay", x = "Length of Stay (days)") + theme(plot.title = element_text(hjust = 0.5))
```

- First ICU unit  

```{r}
icu %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% ggplot() + geom_bar(mapping = aes(x = FIRST_CAREUNIT)) + labs(title = "Plot of First ICU Unit", x = "First ICU Unit") + theme(plot.title = element_text(hjust = 0.5))
```

Let's merge the `ADMISSION.csv`, `PATIENTS.csv`, `ICUSTAYS.csv` together by `SUBJECT_ID`

```{r}
adm_unique <- admission %>% distinct(SUBJECT_ID, .keep_all = TRUE) %>% select("SUBJECT_ID","ADMITTIME")

icu_uniq <- icu %>% distinct(SUBJECT_ID, .keep_all = TRUE)
icu %>% distinct(ICUSTAY_ID, .keep_all = TRUE)

icu_patient_adm <- inner_join(icu_uniq, patient_adm, by = "SUBJECT_ID")
```

- Gender

```{r}
icu_patient_adm %>% ggplot() + geom_bar(mapping = aes(x = factor(GENDER), y = ..prop.., group = 1), stat = "count") + scale_x_discrete(label = c("Female", "Male")) + labs(title = "Gender of Patients", y = "Proportion", x = "Gender") + theme(plot.title = element_text(hjust = 0.5))
```

- Age  

```{r}
icu_patient_adm %>% mutate(age_adm = as.numeric(as.duration(ADMITTIME - DOB), "years")) %>% ggplot() + geom_histogram(mapping = aes(x = age_adm), bins = 50) + labs(title = "Age of Patients", x = "Age (yrs)") + theme(plot.title = element_text(hjust = 0.5))
```


## Q4 

`CHARTEVENTS.csv` (<https://mimic.physionet.org/mimictables/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`D_ITEMS.csv` (<https://mimic.physionet.org/mimictables/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 

Compile a tibble that contains the first ICU stay of unique patients, with the patient's demographic information, the first systolic blood pressure measurement during ICU stay, and whether the patient died within 30 days of hospital admission.


```{r}
charts <- read_csv("/home/203bdata/mimic-iii/CHARTEVENTS.csv")

charts %>% distinct(SUBJECT_ID, .keep_all = TRUE)
ditems <- read_csv("/home/203bdata/mimic-iii/D_ITEMS.csv")
View(ditems)
```


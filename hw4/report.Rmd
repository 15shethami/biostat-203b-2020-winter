---
title: "30-Day Mortality Rate of Patients with Pneumonia Admitted to MICU"
author: "Ami Sheth"
output:
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The MIMIC-III (Medical Information Mart for Intensive Care III) is a database containing deidentified health-related data for over 40,000 patients staying in critical care units of Beth Israel Denaconess Medical Center between 2001 and 2012. The database consists of forty different tables pertaining to hospital admissions, patient demographics, patient diagnosis, prescriptions, etc. The following analysis seeks to predict the mortality rate of patients diagnosed with pneumonia who were admitted to the medical intensive care unit (MICU) thirty days after discharge. 

## Data Preparation 

The MIMIC-III data is accessed by connecting to the PostgresSQL database. A cohort of patients directly admitted into MICU is extracted from the `transfer` table which contains information about the physical location of patients throughout their hospital stay. The `d_icd_diagnoses` table labels all diagnoses according to the Dictionary of International Classification of Diseases, 9th Revision (ICD-9 Codes). From this table, all ICD-9 codes related to pneumonia are stored and matched to patients' ICD-9 codes in the `diagnoses_icd` table, so that only patients diagnosed with pnuemonia remain. Pneumonia may not be listed as the principal diagnosis as explained in [the documentation for the `patients` table](https://mimic.physionet.org/mimictables/diagnoses_icd/). The `seq_num` field is a priority ranking for the diagnoses generated at the end of stay. To focus on patients for whom pneumonia was central to their hospitalization, records with pnuemonia in any of the first five diagnosis positions, according to `seq_num`, is kept. The dataset containing only patients from MICU is joined with the dataset containing only pneumonia patients to obtain a cohort restricted to pneumonia patients who were directly admitted into the MICU (`cohort_admissions`)

A new logical variable (`principal_dx`) is added to `cohort_admissions` indicating whether pneumonia is the first diagnosis. A new variable (`drg_severity`) is also added classifying the severity of patients' ailments from 1-4 with 1 as least severe and 4 as most severe. This information is obtained from the `drgcodes` table, containing severity and mortality indicators for `DRG` codes from the All Payers Registry (APR). From the `admissions` table, admission time (`admittime`), discharge time (`dischtime`), date of birth (`dob)`, date of death (`dod`), and age at admission (`age`) are joined to `cohort_admissions` for patients who did not die in hospital and are younger than 90 years old. The dataset is restricted because patients older than 90 have artifically inflated ages to keep the data de-identifiable. Lastly, gender and ethnicity is joined to `cohort_admissions` from the `patients` table. 

### CONSORT Flow Diagram 

The CONSORT flow diagram summarizes these steps to create the desired cohort:

```{r plot, echo=FALSE}
library(shape)
library(diagram)

# set margins and multiplot
par(mfrow = c(1, 1))
par(mar = c(0, 0, 0, 0))

# initialise a plot device
openplotmat()

# position of boxes
# 1st column indicates x axis position between 0 and 1
# 2nd column indicates y axis position between 0 and 1
# automatically assigns vertical position
num_of_boxes <- 7
auto_coords = coordinates(num_of_boxes)
vert_pos = rev(auto_coords[,1])
box_pos <- matrix(nrow = num_of_boxes, ncol = 2, data = 0)
box_pos[1,] = c(0.25, vert_pos[1]) # 1st box
box_pos[2,] = c(0.75, vert_pos[2]) # 2nd box
box_pos[3,] = c(0.75, vert_pos[3]) # 3rd box
box_pos[4,] = c(0.25, vert_pos[4]) # etc...
box_pos[5,] = c(0.75, vert_pos[5])
box_pos[6,] = c(0.75, vert_pos[6])
box_pos[7,] = c(0.25, vert_pos[7])

# content of boxes
box_content <- matrix(nrow = num_of_boxes, ncol = 1, data = 0)
box_content[1] = "All patients in MIMIC-III \n n = 58,976" # 1st box
box_content[2] = "Exclude patients not admitted to MICU \n n = 38,683" # 2nd box
box_content[3] = "Exclude no pneumonia patients or \n pneumonia not labeled as first five diagonses \n n = 16,508" # passes 80 lines but necessary for format
box_content[4] = "Study Cohort with Drug Severity \n n = 5,963" # etc...
box_content[5] = "Exclude patients who died in hospital \n n = 1,188" 
box_content[6] = "Exclude patients of age > 90 \n n = 432"
box_content[7] = "Study cohort with Gender and Ethnicity \n n = 4,542"


# adjust the size of boxes to fit content
box_x <- c(0.20, 0.25, 0.25, 0.20, 0.25, 0.25, 0.22)
box_y <- c(0.07, 0.05, 0.07, 0.07, 0.05, 0.05, 0.07)

# Draw the arrows
straightarrow(from = c(box_pos[1,1],box_pos[2,2]), to = box_pos[2,], lwd = 1)  
straightarrow(from = c(box_pos[1,1],box_pos[3,2]), to = box_pos[3,], lwd = 1) 
straightarrow(from = c(box_pos[4,1],box_pos[5,2]), to = box_pos[5,], lwd = 1)
straightarrow(from = c(box_pos[4,1],box_pos[6,2]), to = box_pos[6,], lwd = 1)
straightarrow(from = box_pos[1,], to = box_pos[4,], lwd = 1)
straightarrow(from = box_pos[4,], to = box_pos[7,], lwd = 1)

# Draw the boxes
for (i in 1:num_of_boxes) {
  textrect(mid = box_pos[i,], radx = box_x[i], rady = box_y[i], 
           lab = box_content[i], 
           shadow.col = "grey")
  }
```


### Code

The following steps are performed to create a cohort of patients who were directly admitted into MICU and were diagnosed with pneumonia. 

Load database libraries

```{r}
library(DBI)
library(RPostgreSQL)
library(tidyverse)
library(lubridate)

```
 
Connect to PostgreSQL 

```{r}
# Load configuration settings
dbdriver <- 'PostgreSQL'
user  <- 'postgres'
password <- 'postgres'
dbname <- 'mimic'
schema <- 'mimiciii'

# Connect to the database using the configuration settings
con <- dbConnect(RPostgreSQL::PostgreSQL(), 
                 dbname = dbname,
                 user = user, 
                 password = password)

# Set the default schema
dbExecute(con, paste("SET search_path TO ", schema, sep=" "))
con
```

Create a (query) table of patients who were directly admitted into MICU

```{r}

tbl(con, "transfers") %>%
  select(subject_id, hadm_id, prev_careunit, curr_careunit) %>%
  filter(is.na(prev_careunit) & curr_careunit == "MICU") %>%
  select(subject_id, hadm_id) %>%
  distinct() %>%
  print() -> micu_admissions

# collect(micu_admissions)
```

Restrict to pneumonia patients; to find all possible ICD-9 codes related to pneumonia, search for string `pneumonia` in the `long_title` of table `d_icd_diagnoses`

```{r}

tbl(con, "d_icd_diagnoses") %>%
  filter(str_detect(tolower(long_title), "pneumonia")) %>%
  print() -> pneu_codes

```

`diagnoses_icd` table stores the diagnosis of each admission. We use `semi_join()` to keep the rows in `diagnoses_icd` that match the ICD-9 codes related to pneumonia

```{r}
tbl(con, "diagnoses_icd") %>%
  semi_join(pneu_codes, by = "icd9_code") %>%
  print() -> pneu_admissions

 # collect(pneu_admissions)
```

Include records with pneumonia in any of the first five diagnosis positions, according to the `seq_num` field. `group_by()` to limit the query to the first pneumonia diagnosis for each admission

```{r}
pneu_admissions %>%
  filter(seq_num <= 5) %>%
  group_by(subject_id, hadm_id) %>%
  filter(min_rank(seq_num) <= 1) %>%
  ungroup() %>%
  select(subject_id, hadm_id, icd9_code, seq_num) %>%
  print() -> pneu_admissions

# collect(pneu_admissions)
```

`inner_join` the table of admissions to MICU and the table of admissions that include pneumonia diagnosis

```{r}
micu_admissions %>%
  inner_join(pneu_admissions, by = c("subject_id", "hadm_id")) %>%
  print() -> cohort_admissions

# collect(cohort_admissions)
```

Create a logical variable indicating the pneumonia is the principal diagonosis or not (according to `seq_num`)

```{r}
cohort_admissions %>%
  mutate(principal_dx = seq_num == 1) %>%
  select(-seq_num) %>%
  print() -> cohort_admissions

# collect(cohort_admissions)
```

Pull the drug severity information from `drgcodes` and right-join it to our query table

```{r}
tbl(con, "drgcodes") %>%
  filter(str_detect(drg_type, "APR")) %>%
  select(subject_id, hadm_id, drg_severity) %>%
  right_join(cohort_admissions, by = c("subject_id", "hadm_id")) %>%
  mutate(drg_severity = ifelse(is.na(drg_severity), 1, drg_severity)) %>%
  print() -> cohort_admissions

 # collect(cohort_admissions)
```

Pull the admission time `admittime`, discharge time `dischtime`, date of birth `dob`, and date of death `dod`; keep patients who did not die in hospital

```{r}
cohort_admissions %>%
  left_join(
    select(tbl(con, "admissions"),
           subject_id, hadm_id, admittime, dischtime, hospital_expire_flag
    ), by = c("subject_id", "hadm_id")
  ) %>%
  filter(hospital_expire_flag == 0) %>% # patients who did not die in hospital
  select(-hospital_expire_flag) %>%
  left_join(
    select(tbl(con, "patients"), subject_id, dob, dod),
    by = "subject_id"
  ) %>%
  print(width = Inf) -> cohort_admissions

# collect(cohort_admissions)
```

Add `age` (at admission) variable into the table; remove patients older than 90 yrs from the analysis

```{r}
cohort_admissions %>%
  mutate(tt_death = DATE_PART("day", dod - dischtime)) %>%
  mutate(mortality = tt_death <= 30) %>%
  mutate(age = date_part("year", admittime) - date_part("year", dob)) %>%
  filter(age < 90) %>%
  mutate(age = age - ifelse(
    date_part("month", admittime) < date_part("month", dob) |
      (
        date_part("month", admittime) == date_part("month", dob) &
          date_part("day", admittime) < date_part("day", dob)
      ),
    1,
    0
  )) %>%
  select(-admittime, -dischtime, -dob, -dod, -tt_death) %>%
  select(subject_id, hadm_id, age, mortality, everything()) %>%
  print() -> cohort_admissions

# collect(cohort_admissions)
```

Merge some demographic information (ethnicity, gender) into `cohort_admissions`

```{r}
tbl(con, "admissions") %>%
  select(subject_id, ethnicity) %>%
  distinct() %>%
  print() -> cohort_subjects

# collect(cohort_subjects)
```

```{r}
tbl(con, "patients") %>%
  select(subject_id, gender) %>%
  distinct() %>%
  full_join(cohort_subjects, by = "subject_id") %>%
  print() -> cohort_subjects

# collect(cohort_subjects)
```

```{r}
cohort_subjects %>%
  semi_join(cohort_admissions, by = "subject_id") %>%
  print() -> cohort_subjects

# collect(cohort_subjects)
```

Resolve some diversity and inconsistency in the `ethnicity` field

```{r}
unknown_ethnicity <- c(
  "OTHER",
  "UNABLE TO OBTAIN",
  "UNKNOWN/NOT SPECIFIED",
  "MULTI RACE ETHNICITY",
  "PATIENT DECLINED TO ANSWER",
  "UNKNOWN"
)

cohort_subjects %>%
  collect() %>%
  mutate(ethnic_group = case_when(
    str_detect(ethnicity, "^ASIAN") ~ "ASIAN",
    str_detect(ethnicity, "^BLACK") ~ "BLACK",
    str_detect(ethnicity, "^HISPANIC") ~ "HISPANIC",
    str_detect(ethnicity, "^WHITE") ~ "WHITE",
    ethnicity %in% unknown_ethnicity ~ NA_character_,
    TRUE ~ NA_character_
  )) %>%
  select(subject_id, gender, ethnic_group) %>%
  print() -> cohort_subjects
```

Some patients are coded as belonging to more than one ethnic group. To resolve these inconsistencies, define a helper function to pick the modal value from a vector of values in R, which can be used by the `summarize()` function to choose one ethnic group for each patient

```{r}
most <- function(x) {
  if (all(is.na(x))) return(NA_character_)
  y <- table(x, useNA = "no")
  if (length(which(y == max(y))) > 1) return(NA_character_)
  return(names(y)[which.max(y)])
}

cohort_subjects %>%
  group_by(subject_id) %>%
  summarize(ethnic_group = most(ethnic_group)) %>%
  ungroup() %>%
  mutate(ethnic_group = ifelse(is.na(ethnic_group), "UNKNOWN", ethnic_group)) %>%
  print() -> cohort_ethnic_groups
```

```{r}
cohort_subjects %>%
  select(subject_id, gender) %>%
  left_join(cohort_ethnic_groups, by = "subject_id") %>%
  print() -> cohort_subjects
```

Add the demographic information `gender` and `ethnicity` into our `cohort_admissions` table

```{r}
cohort_admissions %>%
  left_join(cohort_subjects, by = "subject_id", copy = TRUE) %>%
  print() -> cohort_admissions

# collect(cohort_admissions)
```

Save the `cohort_admissions` into a csv file for data visualization and analysis

```{r}
final_cohort <- collect(cohort_admissions)
```

Close the connection to database

```{r}
dbDisconnect(con)
```


## Data Visualization

### Plots for Demographic Features 

```{r, echo = FALSE}

# Gender 
final_cohort %>%
  distinct(subject_id, .keep_all = TRUE) %>%
  ggplot(aes(x = gender)) + 
  geom_bar(fill = "lightblue3") + 
  scale_x_discrete(labels = c("Female", "Male")) +
  labs(title = "Barplot of Gender", x = "Gender") +
  theme_minimal()

# Age
final_cohort %>% 
  distinct(subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = age)) +
  geom_histogram(bins = 30, fill = "lightblue3") + 
  labs(title = "Histogram of Age", x = "Age") + 
  theme_minimal()

# Ethnic Group
final_cohort %>% 
  distinct(subject_id, .keep_all = TRUE) %>% 
  ggplot(aes(x = ethnic_group)) +
  geom_bar(fill = "lightblue3") + 
  labs(title = "Barplot of Ethnicity", x = "Ethnicity") + 
  theme_minimal()

```

### Plots for Patients Relationship to Pneumonia 

```{r, echo=FALSE}

# Drug Severity 
final_cohort %>% 
  ggplot(aes(x = drg_severity)) + 
  geom_bar(fill = "lightblue3") + 
  labs(title = "Graph of Drug Severity", x = "Drug Severity") +
  theme_minimal()

# Principle Disease
final_cohort %>% 
  ggplot(aes(x = principal_dx)) + 
  geom_bar(fill = "lightblue3") + 
  scale_x_discrete(labels = c("No", "Yes")) +
  labs(title = "Pneumonia as Principle Diagnosis", x = NULL) +
  theme_minimal()

# ICDA_Code 
final_cohort %>%
  count(icd9_code) %>%
  arrange(desc(n)) %>%
  head(n = 10) %>% 
  ggplot(aes(x = icd9_code, y = n)) + 
  geom_bar(stat = "identity", fill = "lightblue3") +
  coord_flip() + 
  scale_x_discrete(labels = c("Pneumococcal Septicemia",
                              "Pneumococcal Pneumonia",
                              "Klebsiella Pneumoniae",
                              "Pseudomonal",
                              "Methicillin Susceptible due to Staph",
                              "Methicillin Resistant due to Staph",
                              "Due to Gram-Negative Bacteria",
                              "Bacterial, unspecified",
                              "Pneumonia, unspecified",
                              "Ventilator Associated"
                              )) + 
  labs(title = "Top 10 Pneumonia Diagnosis", x = "Type of Pneumonia", 
       y = "count") +
  theme_minimal()

# Mortality 
final_cohort %>% 
  ggplot(aes(x = mortality)) + 
  geom_bar(fill = "lightblue3") + 
  scale_x_discrete(labels = c("Yes", "No", "NA")) + 
  labs(title = "Barplot of Mortality after 30 Days of Discharge",
       x = "Death") + 
  theme_minimal()

```

## Analysis 

In order to predict the mortality rate 

### 1. Logistic Regression 

### 2. Neural Network 

## Conclusion 